@page "/"
@model AdminPanel.Pages.Admin.IndexModel
@{
ViewData["Title"] = "Admin";
}

<div class="container-fluid px-2">

    <div class="d-flex flex-row justify-content-between align-items-center my-2">
        <h1 class="h4 mb-0">Admin</h1>
        <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" id="autoRefreshToggle">
            <label class="form-check-label small" for="autoRefreshToggle">Auto 15s</label>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body py-2">
            <form method="post" asp-page-handler="SetPassword"
                  class="d-flex flex-row flex-wrap align-items-center gap-2 m-0">
                <div class="small text-muted fw-bold">Current password</div>
                <code class="px-2 py-1 bg-light rounded">@Model.CurrentUnlockPassword</code>

                <div class="vr d-none d-sm-block" style="height:22px;"></div>

                <div class="small text-muted fw-bold">New</div>
                <input type="password" name="newPassword"
                       class="form-control form-control-sm"
                       style="max-width:220px" placeholder="New password" />
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-sm btn-primary fw-bold">Save</button>

                @if (TempData["Msg"] is string msg && !string.IsNullOrWhiteSpace(msg))
                {
                <span class="text-success small ms-1">@msg</span>
                }
            </form>
        </div>
    </div>

    @if (Model.Agents.Count == 0)
    {
    <div class="alert alert-secondary">No active agents.</div>
    }
    else
    {
    <div class="d-flex flex-column gap-3">
        @foreach (var kv in Model.Agents)
        {
        var machine = kv.Key;
        var rec = kv.Value;
        Model.Policies.TryGetValue(machine, out var pol);
        var allowedIso = pol?.AllowedUntil.ToString("O") ?? "";

        <div class="card shadow-sm admin-card">
            <div class="card-body">

                <div class="d-flex flex-row flex-wrap align-items-center justify-content-between gap-2">
                    <div class="machine-name">@rec.Status.Machine</div>

                    <div class="d-flex align-items-center gap-2 ms-auto me-2">
                        @if (pol?.RequireLock == true)
                        {
                        <span class="badge badge-status bg-danger">LOCK</span>
                        }
                        else
                        {
                        <span class="badge badge-status bg-success">OK</span>
                        }
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <span class="label-timeleft fw-bold text-muted">Time left</span>
                        <span class="badge badge-remaining js-remaining-badge"
                              data-allowed-until="@allowedIso">--</span>
                    </div>
                </div>

                <form method="post" class="mt-3">
                    <input type="hidden" name="machine" value="@machine" />
                    @Html.AntiForgeryToken()

                    <!-- Minutes -->
                    <div class="input-group input-group-lg mb-2">
                        <span class="input-group-text fw-bold">Minutes</span>
                        <input type="number" name="minutes" value="30" min="0"
                               class="form-control" placeholder="Minutes" />
                    </div>

                    <!-- Add / Set -->
                    <div class="row g-2">
                        <div class="col-6">
                            <button type="submit" formaction="?handler=AddTime"
                                    class="btn btn-success btn-lg w-100 fw-bold">Add</button>
                        </div>
                        <div class="col-6">
                            <button type="submit" formaction="?handler=SetTime"
                                    class="btn btn-warning btn-lg w-100 fw-bold">Set</button>
                        </div>
                    </div>

                    <!-- Sleep / Shutdown -->
                    <div class="row g-2 mt-3">
                        <div class="col-6">
                            <button type="submit" formaction="?handler=Sleep"
                                    class="btn btn-outline-secondary btn-lg w-100 fw-bold">Sleep</button>
                        </div>
                        <div class="col-6">
                            <button type="submit" formaction="?handler=Shutdown"
                                    class="btn btn-outline-danger btn-lg w-100 fw-bold">Off</button>
                        </div>
                    </div>

                    <!-- Password time -->
                    <div class="d-flex gap-2 mt-3 align-items-center">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text fw-bold">Pwd time</span>
                            <input type="number" name="graceMinutes"
                                   value="@(pol?.ManualUnlockGraceMinutes ?? 60)"
                                   min="0" max="240"
                                   class="form-control" placeholder="Password time (min)" />
                        </div>
                        <button type="submit" formaction="?handler=SetGrace"
                                class="btn btn-outline-primary btn-lg fw-bold">Set</button>
                    </div>
                </form>
            </div>
        </div>
        }
    </div>
    }
</div>

@section Scripts {
<script>
    (function () {
        function pad(n) { return n < 10 ? '0' + n : '' + n; }
        function updateRemaining() {
            const nodes = document.querySelectorAll('.js-remaining-badge');
            const now = new Date();
            nodes.forEach(n => {
                const iso = n.getAttribute('data-allowed-until');
                n.classList.remove('bg-success', 'bg-warning', 'bg-danger', 'bg-secondary');
                if (!iso) { n.textContent = '-'; n.classList.add('bg-secondary'); return; }
                const until = new Date(iso);
                if (isNaN(until.getTime())) { n.textContent = '-'; n.classList.add('bg-secondary'); return; }
                let diff = Math.floor((until - now) / 1000);
                if (diff <= 0) { n.textContent = '0s'; n.classList.add('bg-danger'); return; }
                const h = Math.floor(diff / 3600); diff -= h * 3600;
                const m = Math.floor(diff / 60); const s = diff - m * 60;
                n.textContent = (h > 0 ? (h + 'h ') : '') + m + 'm ' + pad(s) + 's';
                const totalMin = (until - now) / 60000;
                if (totalMin > 15) n.classList.add('bg-success');
                else if (totalMin > 5) n.classList.add('bg-warning');
                else n.classList.add('bg-danger');
            });
        }
        updateRemaining();
        setInterval(updateRemaining, 1000);

        const KEY = 'autoRefresh15Enabled';
        const toggle = document.getElementById('autoRefreshToggle');
        let refreshTimer = null;
        function startAutoRefresh() { if (!refreshTimer) refreshTimer = setInterval(() => location.reload(), 15000); }
        function stopAutoRefresh() { if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; } }
        const saved = localStorage.getItem(KEY);
        const enabled = (saved === null) ? true : saved === '1';
        toggle.checked = enabled;
        if (enabled) startAutoRefresh();
        toggle.addEventListener('change', function () {
            if (toggle.checked) { localStorage.setItem(KEY, '1'); startAutoRefresh(); }
            else { localStorage.setItem(KEY, '0'); stopAutoRefresh(); }
        });
    })();
</script>
}
